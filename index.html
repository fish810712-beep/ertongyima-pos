<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>POS</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { margin:0; font-family:sans-serif; background:#f5f2ed; }
header { background:#c8b9a6; padding:12px; text-align:center; font-weight:bold; }

.main { display:flex; height:calc(100vh - 50px); }
.left { flex:2; padding:15px; }
.right { flex:1; background:#fff; padding:15px; border-left:2px solid #ddd; }

.amount-grid {
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
}
.amount-btn {
  background:#fff;
  border:2px solid #4aa3ff;
  color:#4aa3ff;
  font-size:22px;
  padding:20px;
  border-radius:10px;
}
.amount-btn:active { background:#4aa3ff; color:#fff; }

.cart-item {
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid #eee;
  padding:6px 0;
}

.total {
  text-align:right;
  font-size:32px;
  color:#c0392b;
  margin:10px 0;
}

.count { text-align:right; font-size:16px; }

.btn {
  width:100%;
  padding:14px;
  margin-top:8px;
  font-size:18px;
  border:none;
  border-radius:8px;
}
.checkout { background:#6b8e23; color:#fff; }
.clear { background:#ccc; }

input[type="text"] {
  width:100%;
  padding:10px;
  font-size:18px;
  margin-bottom:10px;
}
</style>
</head>

<body>
<header>POS</header>

<div class="main">
  <!-- LEFT -->
  <div class="left">
    <input id="barcode" placeholder="掃描條碼" autofocus />

    <div class="amount-grid">
      <button class="amount-btn" onclick="addAmount(10)">$10</button>
      <button class="amount-btn" onclick="addAmount(20)">$20</button>
      <button class="amount-btn" onclick="addAmount(30)">$30</button>
      <button class="amount-btn" onclick="addAmount(50)">$50</button>
      <button class="amount-btn" onclick="addAmount(100)">$100</button>
      <button class="amount-btn" onclick="addAmount(200)">$200</button>
      <button class="amount-btn" onclick="addAmount(300)">$300</button>
      <button class="amount-btn" onclick="addAmount(500)">$500</button>
    </div>

    <hr>
    <input type="file" onchange="importExcel(this)" />
    <button class="btn" onclick="exportExcel()">匯出庫存 Excel</button>
  </div>

  <!-- RIGHT -->
  <div class="right">
    <div id="cart"></div>
    <div class="count">件數：<span id="count">0</span></div>
    <div class="total">$<span id="total">0</span></div>

    <button class="btn clear" onclick="clearCart()">清空</button>
    <button class="btn checkout" onclick="checkout()">結帳完成</button>
  </div>
</div>

<script>
let cart = [];
let inventory = JSON.parse(localStorage.getItem("inventory")||"{}");
let sales = JSON.parse(localStorage.getItem("sales")||"[]");

function addAmount(price){
  cart.push({ price });
  render();
}

function render(){
  const cartDiv = document.getElementById("cart");
  cartDiv.innerHTML="";
  let total=0;
  cart.forEach((i,idx)=>{
    total+=i.price;
    cartDiv.innerHTML+=`
      <div class="cart-item">
        <span>$${i.price}</span>
        <button onclick="removeItem(${idx})">✕</button>
      </div>`;
  });
  document.getElementById("total").innerText=total;
  document.getElementById("count").innerText=cart.length;
}

function removeItem(i){
  cart.splice(i,1);
  render();
}

function clearCart(){
  cart=[];
  render();
}

function checkout(){
  if(cart.length===0) return;
  sales.push({ time:new Date().toISOString(), total:cart.reduce((a,b)=>a+b.price,0) });
  localStorage.setItem("sales",JSON.stringify(sales));
  clearCart();
  alert("結帳完成");
}

// 條碼槍
document.getElementById("barcode").addEventListener("change",e=>{
  const code=e.target.value;
  if(inventory[code]){
    addAmount(inventory[code].price);
    inventory[code].stock--;
    localStorage.setItem("inventory",JSON.stringify(inventory));
  }
  e.target.value="";
});

// Excel
function importExcel(input){
  const reader=new FileReader();
  reader.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:"binary"});
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    rows.forEach(r=>{
      inventory[r.barcode]={ price:r.price, stock:r.stock };
    });
    localStorage.setItem("inventory",JSON.stringify(inventory));
    alert("庫存已同步");
  };
  reader.readAsBinaryString(input.files[0]);
}

function exportExcel(){
  const rows=Object.entries(inventory).map(([k,v])=>({barcode:k,...v}));
  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"inventory");
  XLSX.writeFile(wb,"inventory.xlsx");
}
</script>
</body>
</html>
