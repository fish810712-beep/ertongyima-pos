<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>二童一馬 POS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#f4f1ec}
header{background:#cbb8a5;padding:12px;text-align:center;font-size:20px;font-weight:bold}

nav{display:flex;background:#eee}
nav button{flex:1;padding:12px;border:none;font-size:16px}

.page{display:none;height:calc(100vh - 110px)}
.page.active{display:flex}

.left{flex:2;padding:15px}
.right{flex:1;background:#fff;padding:15px;border-left:2px solid #ddd}

.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.price-btn{padding:20px;font-size:22px;border:none;border-radius:10px;background:#fff}

.cart-item{display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:6px 0}
.total{font-size:32px;color:#c0392b;text-align:right}
.count{text-align:right;margin-top:5px}

button.action{width:100%;padding:12px;margin-top:8px;font-size:18px}
</style>
</head>

<body>
<header>二童一馬 POS</header>

<nav>
  <button onclick="show('pos')">結帳</button>
  <button onclick="show('stock')">庫存</button>
  <button onclick="show('report')">報表</button>
</nav>

<!-- POS -->
<div id="pos" class="page active">
  <div class="left">
    <input id="barcode" placeholder="掃描條碼" style="width:100%;font-size:18px;padding:8px"><br><br>
    <div class="grid" id="prices"></div>
  </div>
  <div class="right">
    <div id="cart"></div>
    <div class="count">件數：<span id="count">0</span></div>
    <div class="total">$<span id="total">0</span></div>
    <button class="action" onclick="clearCart()">清空</button>
    <button class="action" onclick="checkout()">結帳完成</button>
  </div>
</div>

<!-- 庫存 -->
<div id="stock" class="page">
  <div style="padding:15px;width:100%">
    <h3>庫存管理</h3>
    <table border="1" width="100%" id="stockTable"></table>
    <button class="action" onclick="exportStock()">匯出庫存 Excel</button>
  </div>
</div>

<!-- 報表 -->
<div id="report" class="page">
  <div style="padding:15px;width:100%">
    <h3>營收報表</h3>
    <div id="today"></div>
    <div id="month"></div>
    <button class="action" onclick="exportSales()">匯出營收 Excel</button>
  </div>
</div>

<script>
const prices=[100,150,190,200,250,290,300,350,390,400,450,490,500,550,590,600,650,690,700,790,800,890];

let inventory=JSON.parse(localStorage.getItem("inventory")||"{}");
let cart=[];
let sales=JSON.parse(localStorage.getItem("sales")||"[]");

prices.forEach(p=>{
  if(!inventory[p]) inventory[p]={price:p,stock:50};
});

const priceDiv=document.getElementById("prices");
prices.forEach(p=>{
  const b=document.createElement("button");
  b.className="price-btn";
  b.innerText="$"+p;
  b.onclick=()=>add(p);
  priceDiv.appendChild(b);
});

function add(p){
  if(inventory[p].stock<=0) return alert("庫存不足");
  inventory[p].stock--;
  cart.push(p);
  save();
  render();
}

function render(){
  let total=0;
  const c=document.getElementById("cart");
  c.innerHTML="";
  cart.forEach((p,i)=>{
    total+=p;
    c.innerHTML+=`<div class="cart-item">$${p}<button onclick="remove(${i})">✕</button></div>`;
  });
  document.getElementById("count").innerText=cart.length;
  document.getElementById("total").innerText=total;
}

function remove(i){
  const p=cart[i];
  inventory[p].stock++;
  cart.splice(i,1);
  save();render();
}

function clearCart(){
  cart.forEach(p=>inventory[p].stock++);
  cart=[];save();render();
}

function checkout(){
  if(cart.length===0)return;
  sales.push({time:new Date().toISOString(),count:cart.length,total:cart.reduce((a,b)=>a+b,0)});
  save();
  cart=[];
  render();
  alert("結帳完成");
}

function save(){
  localStorage.setItem("inventory",JSON.stringify(inventory));
  localStorage.setItem("sales",JSON.stringify(sales));
}

document.getElementById("barcode").addEventListener("change",e=>{
  const v=Number(e.target.value);
  if(prices.includes(v)) add(v);
  e.target.value="";
});

function show(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==="stock") drawStock();
  if(id==="report") drawReport();
}

function drawStock(){
  const t=document.getElementById("stockTable");
  t.innerHTML="<tr><th>金額</th><th>庫存</th></tr>";
  Object.values(inventory).forEach(i=>{
    t.innerHTML+=`<tr><td>$${i.price}</td><td>${i.stock}</td></tr>`;
  });
}

function drawReport(){
  const today=new Date().toISOString().slice(0,10);
  let d=0,m=0;
  sales.forEach(s=>{
    if(s.time.startsWith(today)) d+=s.total;
    if(s.time.slice(0,7)===today.slice(0,7)) m+=s.total;
  });
  document.getElementById("today").innerText="今日營收：$"+d;
  document.getElementById("month").innerText="本月營收：$"+m;
}

function exportStock(){
  const ws=XLSX.utils.json_to_sheet(Object.values(inventory));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"stock");
  XLSX.writeFile(wb,"stock.xlsx");
}

function exportSales(){
  const ws=XLSX.utils.json_to_sheet(sales);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"sales");
  XLSX.writeFile(wb,"sales.xlsx");
}

render();
</script>
</body>
</html>
