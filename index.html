<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>二童一馬 POS</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont;
  background: #fff5ef;
  padding: 10px;
}
h1 { text-align:center; }
button {
  padding: 12px;
  margin: 5px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
  background: #ffb3a7;
}
#priceButtons button {
  width: 90px;
}
#cart {
  background: #fff;
  padding: 10px;
  border-radius: 10px;
  min-height: 120px;
}
.cart-item {
  padding: 6px;
  border-bottom: 1px dashed #ccc;
}
</style>
</head>

<body>

<h1>二童一馬 POS</h1>

<div id="priceButtons"></div>

<h3>結帳欄</h3>
<div id="cart"></div>

<div id="barcodeMsg" style="color:red;height:20px;"></div>

<h3>總件數：<span id="count">0</span></h3>
<h3>總金額：$<span id="total">0</span></h3>

<button onclick="checkout()">完成結帳</button>

<hr>

<h3>日結</h3>
<div id="daily"></div>
<button onclick="exportDaily()">匯出日結 Excel</button>

<h3>月結</h3>
<div id="monthly"></div>
<button onclick="exportMonthly()">匯出月結 Excel</button>

<hr>

<h3>庫存管理</h3>
<input id="bcode" placeholder="條碼">
<input id="bprice" placeholder="金額">
<input id="bqty" placeholder="數量">
<button onclick="saveInv()">儲存庫存</button>

<script>
/* ===== 基本資料 ===== */
let cart = document.getElementById("cart");
let totalEl = document.getElementById("total");
let countEl = document.getElementById("count");

let total = 0;
let count = 0;

let todayTotal = Number(localStorage.getItem("todayTotal")) || 0;
let todayCount = Number(localStorage.getItem("todayCount")) || 0;

let inventory = JSON.parse(localStorage.getItem("inventory")) || {};
let monthlyData = JSON.parse(localStorage.getItem("monthlyData")) || {};

/* ===== 金額鍵 ===== */
let prices = [100,150,200,250,290,300,350,390,400,450,490,500,550,590,600,650,690,700,750,790];

function renderPrices(){
  let box = document.getElementById("priceButtons");
  prices.forEach(p=>{
    let b = document.createElement("button");
    b.innerText = "$"+p;
    b.onclick = ()=>addItem(p);
    box.appendChild(b);
  });
}
renderPrices();

/* ===== 加入商品 ===== */
function addItem(price, barcode=null){
  let div = document.createElement("div");
  div.className = "cart-item";
  div.innerText = "$"+price;
  div.onclick = ()=>{
    total -= price;
    count--;
    todayTotal -= price;
    todayCount--;
    if(barcode && inventory[barcode]){
      inventory[barcode].qty++;
      localStorage.setItem("inventory", JSON.stringify(inventory));
    }
    div.remove();
    update();
  };
  cart.appendChild(div);
  total += price;
  count++;
  todayTotal += price;
  todayCount++;
  update();
}

function update(){
  totalEl.innerText = total;
  countEl.innerText = count;
  localStorage.setItem("todayTotal", todayTotal);
  localStorage.setItem("todayCount", todayCount);
  document.getElementById("daily").innerText =
    `件數：${todayCount} 金額：$${todayTotal}`;
}

/* ===== 條碼掃描 ===== */
let buf="";
document.addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    scan(buf);
    buf="";
  } else {
    buf+=e.key;
  }
});

function scan(code){
  let item = inventory[code];
  if(!item){ msg("查無條碼"); return; }
  if(item.qty<=0){ msg("庫存不足"); return; }
  item.qty--;
  inventory[code]=item;
  localStorage.setItem("inventory", JSON.stringify(inventory));
  addItem(item.price, code);
}

function msg(t){
  let m=document.getElementById("barcodeMsg");
  m.innerText=t;
  setTimeout(()=>m.innerText="",1000);
}

/* ===== 結帳 ===== */
function checkout(){
  let key = new Date().getFullYear()+"-"+(new Date().getMonth()+1);
  if(!monthlyData[key]) monthlyData[key]={total:0,count:0};
  monthlyData[key].total += total;
  monthlyData[key].count += count;
  localStorage.setItem("monthlyData", JSON.stringify(monthlyData));
  cart.innerHTML="";
  total=0;count=0;
  update();
  updateMonth();
}

/* ===== 庫存 ===== */
function saveInv(){
  let c=bcode.value,p=Number(bprice.value),q=Number(bqty.value);
  inventory[c]={price:p,qty:q};
  localStorage.setItem("inventory", JSON.stringify(inventory));
  alert("已存");
}

/* ===== 報表 ===== */
function updateMonth(){
  let t="";
  for(let m in monthlyData){
    t+=`${m} 件數:${monthlyData[m].count} 金額:$${monthlyData[m].total}\n`;
  }
  document.getElementById("monthly").innerText=t;
}
updateMonth();

/* ===== 匯出 Excel ===== */
function exportCSV(name,rows){
  let csv=rows.map(r=>r.join(",")).join("\n");
  let a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download=name;
  a.click();
}

function exportDaily(){
  exportCSV("日結.csv",[["件數","金額"],[todayCount,todayTotal]]);
}
function exportMonthly(){
  let r=[["月份","件數","金額"]];
  for(let m in monthlyData){
    r.push([m,monthlyData[m].count,monthlyData[m].total]);
  }
  exportCSV("月結.csv",r);
}

/* ===== 每日備份 ===== */
let d=new Date().toLocaleDateString();
if(!localStorage.getItem("backup_"+d)){
  localStorage.setItem("backup_"+d,JSON.stringify({
    inventory,monthlyData,todayTotal,todayCount
  }));
}
</script>

</body>
</html>
